name: Linux Build

on:
  push:
    branches: [main, develop, "stage-*"]
  pull_request:
    branches: [main, develop]

jobs:
  build-gcc:
    name: GCC ${{ matrix.gcc-version }} (${{ matrix.build-type }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        gcc-version: [11, 13]
        build-type: [Debug, Release]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-${{ matrix.gcc-version }} g++-${{ matrix.gcc-version }} \
            cmake ninja-build \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libxext-dev libwayland-dev \
            libxkbcommon-dev libasound2-dev libpulse-dev

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=gcc-${{ matrix.gcc-version }} \
            -DCMAKE_CXX_COMPILER=g++-${{ matrix.gcc-version }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DGLOAMING_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --parallel $(nproc)

  build-clang:
    name: Clang ${{ matrix.clang-version }} (${{ matrix.build-type }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        clang-version: [14, 16]
        build-type: [Debug, Release]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-${{ matrix.clang-version }} \
            cmake ninja-build \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libxext-dev libwayland-dev \
            libxkbcommon-dev libasound2-dev libpulse-dev

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=clang-${{ matrix.clang-version }} \
            -DCMAKE_CXX_COMPILER=clang++-${{ matrix.clang-version }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DGLOAMING_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --parallel $(nproc)

  # Optional: Build with Steamworks SDK (validates conditional compilation)
  build-steam:
    name: GCC 13 + GLOAMING_STEAM (compile-only)
    runs-on: ubuntu-22.04
    if: false  # Disabled: Steamworks SDK is not publicly available.
               # Enable when SDK is placed at $STEAMWORKS_SDK_DIR.

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-13 g++-13 \
            cmake ninja-build \
            libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libxext-dev libwayland-dev \
            libxkbcommon-dev libasound2-dev libpulse-dev

      - name: Configure with GLOAMING_STEAM
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=gcc-13 \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_BUILD_TYPE=Release \
            -DGLOAMING_STEAM=ON \
            -DSTEAMWORKS_SDK_DIR=${{ github.workspace }}/third_party/steamworks \
            -DGLOAMING_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)
